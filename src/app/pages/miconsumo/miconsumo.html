<div class="contenedor-principal">
  <h2>Mi Consumo</h2>

  <!-- BOTÓN ABRIR FORMULARIO -->
  <button class="btn-toggle" (click)="toggleFormulario()">
    {{ mostrarFormulario ? 'Cerrar formulario' : 'Registrar consumo' }}
  </button>

  <!-- FORMULARIO -->
  <div class="form-card" *ngIf="mostrarFormulario">
    <form [formGroup]="form">
      <div class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>Recurso</mat-label>
          <mat-select formControlName="FKRecurso">
            <mat-option value="">Seleccione</mat-option>
            <mat-option *ngFor="let r of listaRecursos" [value]="r.idRecurso">
              {{ r.nombreRecurso }}
            </mat-option>
          </mat-select>
          <mat-error>
            @if (form.get('FKRecurso')?.hasError('required')) { Ingrese el tipo de recurso! }
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Cantidad</mat-label>
          <input matInput type="number" formControlName="Cantidad" />
          <mat-error>
            @if (form.get('Cantidad')?.hasError('required')) { Ingrese cantidad! } @if
            (form.get('Cantidad')?.hasError('min')) { La cantidad debe ser mayor a 0! }
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Costo</mat-label>
          <input matInput type="number" formControlName="Costo" />
          <mat-error>
            @if (form.get('Costo')?.hasError('required')) { Ingrese costo! } @if
            (form.get('Costo')?.hasError('min')) { El costo debe ser mayor a 0! }
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Fecha</mat-label>
          <input matInput [matDatepicker]="picker" formControlName="Fecha" [min]="today" />
          <mat-hint>MM/DD/YYYY</mat-hint>
          <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
          <mat-error>
            @if (form.get('Fecha')?.hasError('required')) { Ingrese fecha! } @if
            (form.get('Fecha')?.hasError('matDatepickerMin')) { La fecha no puede ser antigua! }
          </mat-error>
        </mat-form-field>

        <mat-form-field class="full" appearance="outline">
          <mat-label>Descripción</mat-label>
          <textarea matInput type="text" formControlName="Descripcion" maxlength="200"></textarea>
          <mat-error>
            @if (form.get('Descripcion')?.hasError('required')) { Ingrese descripción! }
          </mat-error>
        </mat-form-field>
      </div>

      <div class="actions">
        <button class="btn-save" (click)="guardarConsumo()" [disabled]="form.invalid">
          {{ editando ? 'Actualizar' : 'Guardar' }}
        </button>

        <button class="btn-cancel" (click)="toggleFormulario()">Cancelar</button>
      </div>
    </form>
  </div>

  <!-- CONTENEDOR GRID -->
  <div class="dashboard-grid">
    <!-- IZQUIERDA - GRAFICOS -->
    <div class="charts-column">
      <!-- BARRAS -->
      <div class="card chart-card">
        <div class="card-header">
          <h3>Consumo por recurso</h3>

          <div class="select-wrapper">
            <select [(ngModel)]="mesSeleccionado" (change)="onMesChange()">
              <option *ngFor="let m of meses" [value]="m.id">{{ m.nombre }}</option>
            </select>
          </div>
        </div>

        <div class="chart-wrapper chart-large">
          <canvas baseChart [type]="barType" [data]="{ labels: barLabels, datasets: barData }" [options]="barOptions">
          </canvas>
        </div>
      </div>

      <!-- AREA -->
      <div class="card chart-card">
        <div class="card-header">
          <h3>Historial Anual</h3>

          <div class="year-select">
            <select [(ngModel)]="anioSeleccionado" (change)="onAnioChange()">
              <option *ngFor="let a of anios" [value]="a">{{ a }}</option>
            </select>
          </div>
        </div>

        <div class="chart-wrapper chart-medium">
          <canvas baseChart [type]="areaType" [data]="{ labels: areaLabels, datasets: areaData }"
            [options]="areaOptions">
          </canvas>
        </div>
      </div>
    </div>

    <!-- DERECHA - REPORTES -->
    <div class="stats-column">
      <div class="card stat-card">
        <h2 class="big-number">S/ {{ totalMes.toFixed(2) }}</h2>
        <p>Consumo total del mes</p>
      </div>

      <div class="card stat-card">
        <h2 class="big-number">S/ {{ promedioRecurso.toFixed(2) }}</h2>
        <p>Promedio por recurso</p>
      </div>

      <div class="card stat-card">
        <h2 class="big-number" [class.positive]="!variacion.includes('-')">
          {{ variacion }}
        </h2>
        <p>Comparado al mes pasado</p>
      </div>
    </div>
  </div>

  <div *ngIf="data.length === 0" class="no-data">
        <mat-icon>info</mat-icon>  No hay consumos registrados.
    </div>

  <!-- LISTA DE CONSUMOS DEBAJO -->
  <div class="contenedor-cards">
    <div class="card-consumo" *ngFor="let c of data">
      <div class="card-header">
        <h3>{{ c.recurso?.nombreRecurso }}</h3>

        <div class="acciones">
          <button class="btn-icon" (click)="editarConsumo(c)">
            <mat-icon>edit</mat-icon>
          </button>

          <button class="btn-icon eliminar" (click)="eliminarConsumo(c.idConsumo)">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>

      <p><strong>Cantidad:</strong> {{ c.cantidad }}</p>
      <p><strong>Costo:</strong> S/ {{ c.costo }}</p>
      <p><strong>Fecha:</strong> {{ c.fecha | date }}</p>
      <p><strong>Descripción:</strong> {{ c.descripcion }}</p>
    </div>
  </div>
</div>